# =============================================================================
# Azure DevOps Pipeline - Infrastructure Deployment (AUTO-GENERATED)
# =============================================================================
# THIS FILE IS AUTO-GENERATED BY THE VENDING PIPELINE
# Do not edit manually - changes will be overwritten!
#
# To add/remove environments, edit environments.yaml and let the
# vending pipeline regenerate this file.
# =============================================================================

trigger:
  branches:
    include:
    - main
  paths:
    include:
    - '*.tf'
    - modules/**
    exclude:
    - .vending/**
    - environments.yaml
    - '*.md'
    - docs/**
pr:
  branches:
    include:
    - main
  paths:
    include:
    - '*.tf'
    - modules/**
    exclude:
    - .vending/**
    - environments.yaml
pool:
  vmImage: ubuntu-latest
variables:
- group: a2026011202-secrets
- name: TF_VERSION
  value: 1.9.0
- name: TF_IN_AUTOMATION
  value: 'true'
stages:
- stage: QualityGates
  displayName: Quality Gates
  jobs:
  - job: Validate
    displayName: Format & Validate
    steps:
    - task: TerraformInstaller@1
      inputs:
        terraformVersion: 1.9.0
    - script: terraform fmt -check -recursive -diff
      displayName: Terraform Format
    - script: 'terraform init -backend=false

        terraform validate'
      displayName: Terraform Validate
- stage: DeployDev
  displayName: Deploy DEV
  dependsOn: QualityGates
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - job: Dev
    displayName: Apply DEV
    steps:
    - task: TerraformInstaller@1
      inputs:
        terraformVersion: 1.9.0
    - bash: 'mkdir -p ~/.terraform.d

        echo "{"credentials":{"app.terraform.io":{"token":"$TFC_TOKEN"}}}" > ~/.terraform.d/credentials.tfrc.json'
      displayName: Configure TFC
    - bash: 'echo "Deploying to workspace: a2026011202n1d01"

        export TF_WORKSPACE="a2026011202n1d01"

        terraform init

        terraform apply -auto-approve'
      displayName: Apply DEV
- stage: DeployQa
  displayName: Deploy QA
  dependsOn: DeployDev
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: Qa
    displayName: Apply QA
    environment: QA
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
          - task: TerraformInstaller@1
            inputs:
              terraformVersion: 1.9.0
          - bash: 'mkdir -p ~/.terraform.d

              echo "{"credentials":{"app.terraform.io":{"token":"$TFC_TOKEN"}}}" >
              ~/.terraform.d/credentials.tfrc.json'
            displayName: Configure TFC
          - bash: 'echo "Deploying to workspace: a2026011202n1q01"

              export TF_WORKSPACE="a2026011202n1q01"

              terraform init

              terraform apply -auto-approve'
            displayName: Apply QA
