# =============================================================================
# Azure DevOps Pipeline - Infrastructure Deployment (AUTO-GENERATED)
# =============================================================================
# THIS FILE IS AUTO-GENERATED BY THE VENDING PIPELINE
# Do not edit manually - changes will be overwritten!
#
# To add/remove environments, edit environments.yaml and let the
# vending pipeline regenerate this file.
# =============================================================================

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - '*.tf'
      - modules/**
    exclude:
      - .vending/**
      - environments.yaml
      - '*.md'
      - docs/**

pr:
  branches:
    include:
      - main
  paths:
    include:
      - '*.tf'
      - modules/**
    exclude:
      - .vending/**
      - environments.yaml

pool:
  vmImage: ubuntu-latest

variables:
  - group: ${APP_ID}a2026011202-secrets
  - name: TF_VERSION
    value: '1.9.0'
  - name: TF_IN_AUTOMATION
    value: 'true'

stages:
  # ===========================================================================
  # Quality Gates
  # ===========================================================================
  - stage: QualityGates
    displayName: Quality Gates
    jobs:
      - job: Validate
        displayName: Format & Validate
        steps:
          - task: TerraformInstaller@1
            inputs:
              terraformVersion: $(TF_VERSION)

          - script: terraform fmt -check -recursive -diff
            displayName: Terraform Format

          - script: |
              terraform init -backend=false
              terraform validate
            displayName: Terraform Validate

  # ===========================================================================
  # Deploy Dev (enabled by default)
  # ===========================================================================
  - stage: DeployDev
    displayName: Deploy DEV
    dependsOn: QualityGates
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: Dev
        displayName: Apply DEV
        steps:
          - task: TerraformInstaller@1
            inputs:
              terraformVersion: $(TF_VERSION)

          - bash: |
              mkdir -p ~/.terraform.d
              cat > ~/.terraform.d/credentials.tfrc.json << EOF
              {"credentials":{"app.terraform.io":{"token":"$(TFC_TOKEN)"}}}
              EOF
            displayName: Configure TFC

          - bash: |
              REPO_NAME="$(Build.Repository.Name)"
              APP_ID="${REPO_NAME##*/}"
              APP_ID="${APP_ID#terraform-azure-infra-}"

              echo "Deploying: ${APP_ID}n1d01"
              export TF_WORKSPACE="${APP_ID}n1d01"
              terraform init
              terraform apply -auto-approve
            displayName: Apply DEV
